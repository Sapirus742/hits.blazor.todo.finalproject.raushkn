@page "/transactions"
@using TheFinalProject.Models
@using TheFinalProject.Data.Services
@inject TransactionService TransactionService
@inject DepartmentService DepartmentService

<h3>Журнал учёта</h3>

<div class="row mb-3">
    <div class="col-md-4">
        <select class="form-control" @onchange="LoadFilteredTransactions">
            <option value="0">Все отделы</option>
            @foreach (var dept in departments)
            {
                <option value="@dept.Id">@dept.Name</option>
            }
        </select>
    </div>
    <div class="col-md-4 text-end">
        <h5>Общий баланс: @transactions.Sum(t => t.OperationType == "Приход" ? t.Amount : -t.Amount) руб.</h5>
    </div>
    <div class="col-md-4 text-end">
        <a href="add-transaction" class="btn btn-success">+ Добавить запись</a>
    </div>
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Дата</th>
            <th>Отдел</th>
            <th>Тип</th>
            <th>Описание</th>
            <th>Сумма</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var t in transactions)
        {
            <tr class="@(t.OperationType == "Расход" ? "table-danger" : "table-success")">
                <td>@t.Date.ToShortDateString()</td>
                <td>@(departments.FirstOrDefault(d => d.Id == t.DepartmentId)?.Name ?? "Н/Д")</td>
                <td>@t.OperationType</td>
                <td>@t.Description</td>
                <td>@t.Amount</td>
            </tr>
        }
    </tbody>
</table>

@code {
    private List<Transaction> transactions = new();
    private List<Department> departments = new();

    protected override async Task OnInitializedAsync()
    {
        departments = await DepartmentService.GetDepartmentsAsync();
        // Первоначальная загрузка - может быть пустой
        transactions = await TransactionService.GetTransactionsAsync();

        // Опционально: заполнить тестовыми данными, если пусто
        await DepartmentService.SeedDataAsync();
    }

    private async Task LoadFilteredTransactions(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int deptId) && deptId > 0)
        {
            // Тут нужно добавить метод фильтрации в сервис, пока загрузим все и отфильтруем в памяти
            // В реальном проекте лучше фильтровать в SQL запросе
            var all = await TransactionService.GetTransactionsAsync();
            transactions = all.Where(t => t.DepartmentId == deptId).ToList();
        }
        else
        {
            transactions = await TransactionService.GetTransactionsAsync();
        }
    }
}
