@page "/reports"
@using TheFinalProject.Models
@using TheFinalProject.Data.Services
@using System.Globalization
@inject TransactionService TransactionService
@inject DepartmentService DepartmentService
@inject IJSRuntime JS

<h3>Финансовые отчёты</h3>

@if (isLoading)
{
    <p><em>Загрузка...</em></p>
}
else if (!transactions.Any())
{
    <div class="alert alert-info">
        <strong>Нет данных для отчёта.</strong> 
        <a href="/add-transaction" class="alert-link">Добавьте транзакции</a> для построения графиков.
    </div>
}
else
{
    <!-- Карточки с основными показателями -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Приход (внешний)</h5>
                    <h2>@($"{totalIncome:N2}") руб.</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5 class="card-title">Расход (внешний)</h5>
                    <h2>@($"{totalExpense:N2}") руб.</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Баланс компании</h5>
                    <h2 class="@(balance >= 0 ? "" : "text-warning")">@($"{balance:N2}") руб.</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-secondary">
                <div class="card-body">
                    <h5 class="card-title">Внутренние переводы</h5>
                    <h2>@($"{internalTransfers:N2}") руб.</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Графики -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5>Распределение по типам операций</h5>
                    @if (!chartsRendered)
                    {
                        <div class="alert alert-info">Загрузка графика...</div>
                    }
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="operationsChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5>Баланс по отделам</h5>
                    @if (!chartsRendered)
                    {
                        <div class="alert alert-info">Загрузка графика...</div>
                    }
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="departmentsChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>


    @if (chartsRendered)
    {
        <div class="alert alert-success">Графики отрисованы</div>
    }

    <!-- Таблица балансов по отделам -->
    <h4>Баланс по отделам</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Отдел</th>
                <th>Приход</th>
                <th>Расход</th>
                <th>Переводы Из</th>
                <th>Переводы В</th>
                <th>Баланс</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var dept in departments)
            {
                var deptTransactions = transactions.Where(t => 
                    t.DepartmentId == dept.Id || 
                    t.TargetDepartmentId == dept.Id
                ).ToList();

                var deptIncome = deptTransactions
                    .Where(t => t.OperationType == "Приход" && t.DepartmentId == dept.Id)
                    .Sum(t => t.Amount);

                var deptExpense = deptTransactions
                    .Where(t => t.OperationType == "Расход" && t.DepartmentId == dept.Id)
                    .Sum(t => t.Amount);

                var transfersOut = deptTransactions
                    .Where(t => t.OperationType == "Внутренний перевод" && t.DepartmentId == dept.Id)
                    .Sum(t => t.Amount);

                var transfersIn = deptTransactions
                    .Where(t => t.OperationType == "Внутренний перевод" && t.TargetDepartmentId == dept.Id)
                    .Sum(t => t.Amount);

                var deptBalance = deptIncome - deptExpense - transfersOut + transfersIn;

                <tr>
                    <td><strong>@dept.Name</strong></td>
                    <td class="text-success">@($"{deptIncome:N2}") руб.</td>
                    <td class="text-danger">@($"{deptExpense:N2}") руб.</td>
                    <td class="text-warning">-@($"{transfersOut:N2}") руб.</td>
                    <td class="text-info">+@($"{transfersIn:N2}") руб.</td>
                    <td class="@(deptBalance >= 0 ? "text-success" : "text-danger") fw-bold">
                        @($"{deptBalance:N2}") руб.
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Последние операции -->
    <h4 class="mt-4">Последние операции</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Дата</th>
                <th>Отдел</th>
                <th>Тип</th>
                <th>Сумма</th>
                <th>Описание</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var t in transactions.OrderByDescending(t => t.Date).Take(10))
            {
                <tr>
                    <td>@t.Date.ToShortDateString()</td>
                    <td>@(departments.FirstOrDefault(d => d.Id == t.DepartmentId)?.Name ?? "Н/Д")</td>
                    <td>
                        <span class="badge @GetBadgeClass(t.OperationType)">
                            @t.OperationType
                        </span>
                    </td>
                    <td>@($"{t.Amount:N2}") руб.</td>
                    <td>@(t.Description ?? "-")</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Transaction> transactions = new();
    private List<Department> departments = new();
    private bool isLoading = true;

    private decimal totalIncome;
    private decimal totalExpense;
    private decimal balance;
    private decimal internalTransfers;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            departments = await DepartmentService.GetDepartmentsAsync();
            transactions = await TransactionService.GetTransactionsAsync();
            CalculateTotals();
        }
        finally
        {
            isLoading = false;
        }
    }

    private bool chartsRendered = false;
    private bool pageLoaded = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!pageLoaded && transactions.Any())
        {
            pageLoaded = true;
            try
            {
                await Task.Delay(300);
                await RenderCharts();
                chartsRendered = true;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Ошибка: {ex.Message}");
            }
        }
    }

    protected override void OnInitialized()
    {
        pageLoaded = false;
        chartsRendered = false;
    }

    private void CalculateTotals()
    {
        totalIncome = transactions
            .Where(t => t.OperationType == "Приход")
            .Sum(t => t.Amount);

        totalExpense = transactions
            .Where(t => t.OperationType == "Расход")
            .Sum(t => t.Amount);

        balance = totalIncome - totalExpense;

        internalTransfers = transactions
            .Where(t => t.OperationType == "Внутренний перевод")
            .Sum(t => t.Amount);
    }

    private string GetBadgeClass(string operationType)
    {
        return operationType switch
        {
            "Приход" => "bg-success",
            "Расход" => "bg-danger",
            "Внутренний перевод" => "bg-warning text-dark",
            _ => "bg-secondary"
        };
    }

    private async Task RenderCharts()
    {
        try
        {
            // Уничтожаем старые графики
            await JS.InvokeVoidAsync("eval", @"
            if (window.operationsChartInstance) {
                window.operationsChartInstance.destroy();
            }
            if (window.departmentsChartInstance) {
                window.departmentsChartInstance.destroy();
            }
        ");

            await JS.InvokeVoidAsync("renderOperationsChart",
                (double)totalIncome,
                (double)totalExpense,
                (double)internalTransfers);

            if (departments.Any())
            {
                var labels = departments.Select(d => d.Name).ToArray();
                var balances = departments.Select(d =>
                {
                    var deptTrans = transactions.Where(t =>
                        t.DepartmentId == d.Id || t.TargetDepartmentId == d.Id);

                    var income = deptTrans.Where(t => t.OperationType == "Приход" && t.DepartmentId == d.Id).Sum(t => t.Amount);
                    var expense = deptTrans.Where(t => t.OperationType == "Расход" && t.DepartmentId == d.Id).Sum(t => t.Amount);
                    var transfersOut = deptTrans.Where(t => t.OperationType == "Внутренний перевод" && t.DepartmentId == d.Id).Sum(t => t.Amount);
                    var transfersIn = deptTrans.Where(t => t.OperationType == "Внутренний перевод" && t.TargetDepartmentId == d.Id).Sum(t => t.Amount);

                    return (double)(income - expense - transfersOut + transfersIn);
                }).ToArray();

                await JS.InvokeVoidAsync("renderDepartmentsChart", labels, balances);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Ошибка: {ex.Message}");
        }
    }

}
